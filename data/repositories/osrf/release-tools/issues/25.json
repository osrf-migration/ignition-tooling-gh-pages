{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/release-tools.json"}, "html": {"href": "#!/osrf/release-tools"}, "avatar": {"href": "data/bytebucket.org/ravatar/{41811d3d-19d0-428e-a134-976595e72508}ts=python"}}, "type": "repository", "name": "release-tools", "full_name": "osrf/release-tools", "uuid": "{41811d3d-19d0-428e-a134-976595e72508}"}, "links": {"attachments": {"href": "data/repositories/osrf/release-tools/issues/25/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/release-tools/issues/25.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/release-tools/issues/25/watch"}, "comments": {"href": "data/repositories/osrf/release-tools/issues/25/comments_page=1.json"}, "html": {"href": "#!/osrf/release-tools/issues/25/homebrew-problem-with-protobuf-and-plugins"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/release-tools/issues/25/vote"}}, "reporter": {"display_name": "Jose Luis Rivero", "uuid": "{d12309b2-f745-42ee-b119-aec4fcdf81fe}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D"}, "html": {"href": "https://bitbucket.org/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/109284c8b83411dbc7492138f6167e9ed=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJR-5.png"}}, "nickname": "Jose Luis Rivero", "type": "user", "account_id": "557058:155a32e2-420c-4d50-98e0-0e722f63f906"}, "title": "Homebrew problem with protobuf and plugins (dlclose)", "component": null, "votes": 0, "watches": 4, "content": {"raw": "Gazebo tests which use ServerFixture fails (both calling them individually or using make test) with the following message related to protobuf:\r\n\r\n```\r\n81: [libprotobuf ERROR google/protobuf/descriptor_database.cc:57] File already exists in database: time.proto\r\n81: [libprotobuf FATAL google/protobuf/descriptor.cc:954] CHECK failed: generated_database_->Add(encoded_file_descriptor, size): \r\n81: \u001b[1;32m[Msg] \u001b[0m\u001b[1;32mWaiting for master.\u001b[0m\u001b[1;32m\r\n81: \u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m[Msg] \u001b[0m\u001b[1;32mConnected to gazebo master @ \u001b[0m\u001b[1;32mhttp://127.0.0.1:11345\u001b[0m\u001b[1;32m\r\n81: \u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m[Msg] \u001b[0m\u001b[1;32mPublicized address: \u001b[0m\u001b[1;32m192.168.0.192\u001b[0m\u001b[1;32m\r\n81: \u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;36m[Dbg] \u001b[0m\u001b[1;36m[\u001b[0m\u001b[1;36mServerFixture.cc\u001b[0m\u001b[1;36m:\u001b[0m\u001b[1;36m146\u001b[0m\u001b[1;36m] \u001b[0m\u001b[1;36mServerFixture load in \u001b[0m\u001b[1;36m1.7\u001b[0m\u001b[1;36m seconds, timeout after \u001b[0m\u001b[1;36m600\u001b[0m\u001b[1;36m seconds\r\n81: libc++abi.dylib: terminating with uncaught exception of type google::protobuf::FatalException: CHECK failed: generated_database_->Add(encoded_file_descriptor, size): \r\n81: \u001b[0m\r\n 81/172 Test  #81: UNIT_ForceTorqueSensor_TEST ....................***Exception: Other  4.91 sec\r\n```\r\nThis error was after applying [the patch of removing dlclose](https://bitbucket.org/osrf/gazebo/issue/1026/osx-seg-faults-during-plugin-teardown#comment-7972838) so they don't segfault on MacOsX. And seems the one described in the [protobuf bug tracker](https://code.google.com/p/protobuf/issues/detail?id=370), still unresolved.\r\n\r\n**Current working case and workarounds:**\r\n\r\n@scpeters was able to run the testsuite without this errors (and I confirm it) from our t1000 machine using a catkin isolated workspace.\r\n\r\nAs a workaround, I have a [homebrew version of protobuf](https://github.com/j-rivero/homebrew-protobuf/blob/master/protobuf.rb) using the [patch](https://code.google.com/p/protobuf/issues/attachmentText?id=370&aid=3700010000&name=quick_patch.diff&token=TmdAgBMCRmuK9P9dGWQAsj_RB4A%3A1392686153119) described in the upstream issue and I can confirm that it is working fine in our jenkins.\r\n\r\nA good point would be to found what is different between the catkin workspace environment in t1000 and my local machine / jenkins.", "markup": "markdown", "html": "<p>Gazebo tests which use ServerFixture fails (both calling them individually or using make test) with the following message related to protobuf:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"nt\">81</span><span class=\"o\">:</span> <span class=\"cp\">[</span><span class=\"nx\">libprotobuf</span> <span class=\"nx\">ERROR</span> <span class=\"nx\">google</span><span class=\"p\">/</span><span class=\"nx\">protobuf</span><span class=\"p\">/</span><span class=\"nx\">descriptor_database.cc</span><span class=\"p\">:</span><span class=\"mi\">57</span><span class=\"cp\">]</span> <span class=\"nt\">File</span> <span class=\"nt\">already</span> <span class=\"nt\">exists</span> <span class=\"nt\">in</span> <span class=\"nt\">database</span><span class=\"o\">:</span> <span class=\"nt\">time</span><span class=\"p\">.</span><span class=\"nc\">proto</span>\n<span class=\"nt\">81</span><span class=\"o\">:</span> <span class=\"cp\">[</span><span class=\"nx\">libprotobuf</span> <span class=\"nx\">FATAL</span> <span class=\"nx\">google</span><span class=\"p\">/</span><span class=\"nx\">protobuf</span><span class=\"p\">/</span><span class=\"nx\">descriptor.cc</span><span class=\"p\">:</span><span class=\"mi\">954</span><span class=\"cp\">]</span> <span class=\"nt\">CHECK</span> <span class=\"nt\">failed</span><span class=\"o\">:</span> <span class=\"nt\">generated_database_-</span><span class=\"o\">&gt;</span><span class=\"nt\">Add</span><span class=\"o\">(</span><span class=\"nt\">encoded_file_descriptor</span><span class=\"o\">,</span> <span class=\"nt\">size</span><span class=\"o\">):</span> \n<span class=\"nt\">81</span><span class=\"o\">:</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mWaiting</span> <span class=\"nx\">for</span> <span class=\"nx\">master.</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span>\n<span class=\"mi\">81</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mConnected</span> <span class=\"k\">to</span> <span class=\"nx\">gazebo</span> <span class=\"nx\">master</span> <span class=\"p\">@</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mhttp</span><span class=\"p\">:</span><span class=\"c1\">//127.0.0.1:11345\u001b[0m\u001b[1;32m</span>\n<span class=\"mi\">81</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mPublicized</span> <span class=\"nx\">address</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m192.168.0.192</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span>\n<span class=\"mi\">81</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Dbg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span><span class=\"err\">[\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">mServerFixture.cc</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span><span class=\"p\">:</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m146</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">mServerFixture</span> <span class=\"n\">load</span> <span class=\"k\">in</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m1.7</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span> <span class=\"nx\">seconds</span><span class=\"p\">,</span> <span class=\"nx\">timeout</span> <span class=\"nx\">after</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m600</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">36</span><span class=\"nx\">m</span> <span class=\"nx\">seconds</span>\n<span class=\"mi\">81</span><span class=\"p\">:</span> <span class=\"nx\">libc</span><span class=\"o\">++</span><span class=\"nx\">abi.dylib</span><span class=\"p\">:</span> <span class=\"nx\">terminating</span> <span class=\"k\">with</span> <span class=\"nx\">uncaught</span> <span class=\"nx\">exception</span> <span class=\"nx\">of</span> <span class=\"k\">type</span> <span class=\"nx\">google</span><span class=\"nl\">::protobuf::FatalException</span><span class=\"p\">:</span> <span class=\"nx\">CHECK</span> <span class=\"nx\">failed</span><span class=\"p\">:</span> <span class=\"nx\">generated_database_</span><span class=\"o\">-&gt;</span><span class=\"nb\">Add</span><span class=\"p\">(</span><span class=\"nx\">encoded_file_descriptor</span><span class=\"p\">,</span> <span class=\"nx\">size</span><span class=\"p\">):</span> \n<span class=\"mi\">81</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span>\n <span class=\"mi\">81</span><span class=\"p\">/</span><span class=\"nx\">172</span> <span class=\"nx\">Test</span>  <span class=\"vi\">#81</span><span class=\"p\">:</span> <span class=\"nx\">UNIT_ForceTorqueSensor_TEST</span> <span class=\"nx\">....................</span><span class=\"o\">***</span><span class=\"nx\">Exception</span><span class=\"p\">:</span> <span class=\"nx\">Other</span>  <span class=\"mf\">4.91</span> <span class=\"nx\">sec</span>\n</pre></div>\n\n\n<p>This error was after applying <a data-is-external-link=\"true\" href=\"https://bitbucket.org/osrf/gazebo/issue/1026/osx-seg-faults-during-plugin-teardown#comment-7972838\" rel=\"nofollow\">the patch of removing dlclose</a> so they don't segfault on MacOsX. And seems the one described in the <a data-is-external-link=\"true\" href=\"https://code.google.com/p/protobuf/issues/detail?id=370\" rel=\"nofollow\">protobuf bug tracker</a>, still unresolved.</p>\n<p><strong>Current working case and workarounds:</strong></p>\n<p>@scpeters was able to run the testsuite without this errors (and I confirm it) from our t1000 machine using a catkin isolated workspace.</p>\n<p>As a workaround, I have a <a data-is-external-link=\"true\" href=\"https://github.com/j-rivero/homebrew-protobuf/blob/master/protobuf.rb\" rel=\"nofollow\">homebrew version of protobuf</a> using the <a data-is-external-link=\"true\" href=\"https://code.google.com/p/protobuf/issues/attachmentText?id=370&amp;aid=3700010000&amp;name=quick_patch.diff&amp;token=TmdAgBMCRmuK9P9dGWQAsj_RB4A%3A1392686153119\" rel=\"nofollow\">patch</a> described in the upstream issue and I can confirm that it is working fine in our jenkins.</p>\n<p>A good point would be to found what is different between the catkin workspace environment in t1000 and my local machine / jenkins.</p>", "type": "rendered"}, "assignee": {"display_name": "Jose Luis Rivero", "uuid": "{d12309b2-f745-42ee-b119-aec4fcdf81fe}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D"}, "html": {"href": "https://bitbucket.org/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/109284c8b83411dbc7492138f6167e9ed=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJR-5.png"}}, "nickname": "Jose Luis Rivero", "type": "user", "account_id": "557058:155a32e2-420c-4d50-98e0-0e722f63f906"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2014-02-18T01:20:59.106001+00:00", "milestone": null, "updated_on": "2017-05-04T21:03:11.203255+00:00", "type": "issue", "id": 25}